<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer Form</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <style>
    .machine-card {
      border-left: 3px solid #0d6efd;
      padding-left: 1rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body class="bg-light py-4">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 id="formTitle">Customer Form</h2>
      <a href="{{ url_for('customer_list') }}" target="formFrame" class="btn btn-outline-secondary">‚Üê Back to List</a>

    </div>

    <form id="mainForm">
      <input type="hidden" id="customerid" name="customerid" value="" />

      <!-- Customer Info -->
      <div class="card mb-4">
        <div class="card-header">Customer</div>
        <div class="card-body row g-3">
          <div class="col-md-6">
            <label class="form-label">Customer Name<span class="text-danger"> *</span></label>
            <input type="text" id="customername" name="customername" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Customer Short Name<span class="text-danger"> *</span></label>
            <input type="text" id="customershortname" name="customershortname" class="form-control" required/>
          </div>
        </div>
      </div>

      <!-- Locations -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Locations</span>
          <button type="button" class="btn btn-sm btn-primary" onclick="addLocation()">
            + Add Location
          </button>
        </div>
        <div class="card-body" id="locationsContainer"></div>
      </div>

      <div class="text-end">
        <button type="submit" class="btn btn-success">Save</button>
        <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
      </div>
    </form>
  </div>

  <script>
    function formatDate(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (isNaN(d)) return ""; // invalid date
  return d.toISOString().split("T")[0]; // YYYY-MM-DD
}

    const params = new URLSearchParams(window.location.search);
    const mode = params.get("mode");
    const editId = Number(params.get("id"));
    const isEditMode = mode === "edit";
    let locationCount = 0;

    // ------------------- Load existing customer data -------------------
    async function loadCustomerData() {
      if (!isEditMode) return;

      try {
        const res = await fetch(`/customers/${editId}`);
        if (!res.ok) {
          alert("Failed to fetch customer");
          return;
        }
        const customer = await res.json();
        document.getElementById("formTitle").textContent = "Edit Customer";
        document.getElementById("customerid").value = customer.customerid;
        document.getElementById("customername").value = customer.customername;
        document.getElementById("customershortname").value = customer.customershortname;

        if (customer.sites) customer.sites.forEach(site => addLocation(site));
      } catch (err) {
        console.error(err);
        alert("Error loading customer data");
      }
    }

    // ------------------- Locations and Machines -------------------
    function addLocation(siteData = {}) {
      const locId = `loc-${locationCount++}`;
      const html = `
        <div class="accordion mb-3" id="locationsAccordion">
  <div class="accordion-item" data-loc-id="${locId}">
    <h2 class="accordion-header" id="head-${locId}">
      <button class="accordion-button ${locId !== 1 ? "collapsed" : ""}" 
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapse-${locId}"
              aria-expanded="${locId === 1 ? "true" : "false"}"
              aria-controls="collapse-${locId}">
        ${siteData.sitename || "New Location"}
      </button>
    </h2>
    <div id="collapse-${locId}" 
         class="accordion-collapse collapse show">
      <div class="accordion-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label>Site Name</label>
                    <input type="text" class="form-control sitename" value="${siteData.sitename || ''}" />
                  </div>
                  <div class="col-md-6">
                    <label>Site Short Name</label>
                    <input type="text" class="form-control site_shortname" value="${siteData.site_shortname || ''}" />
                  </div>
                  <div class="col-md-6">
                    <label>Address line 1</label>
                    <input type="text" class="form-control addr1" value="${siteData.addr1 || ''}" />
                  </div>
                  <div class="col-md-6">
                    <label>Address line 2</label>
                    <input type="text" class="form-control addr2" value="${siteData.addr2 || ''}" />
                  </div>
                  <div class="col-md-3">
                    <label>City</label>
                    <input type="text" class="form-control city" value="${siteData.city || ''}" />
                  </div>
                  <div class="col-md-3">
                    <label>State</label>
                    <input type="text" class="form-control state" value="${siteData.state || ''}" />
                  </div>
                  <div class="col-md-3">
                    <label>Pincode</label>
                    <input type="text" class="form-control pincode" value="${siteData.pincode || ''}" />
                  </div>
                  <div class="col-md-3">
                    <label>Phone</label>
                    <input type="text" class="form-control phone" value="${siteData.phone || ''}" />
                  </div>
                  <div class="col-md-6">
                    <label>Email</label>
                    <input type="email" class="form-control email" value="${siteData.email || ''}" />
                  </div>
                  <div class="col-md-6">
                    <label>GST No</label>
                    <input type="text" class="form-control gstno" value="${siteData.gstno || ''}" />
                  </div>
                </div>
                <hr />
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong>Machines</strong>
                  <button type="button" class="btn btn-outline-primary btn-sm" onclick="addMachine('${locId}')">+ Add Machine</button>
                </div>
                <div class="machines-container" data-loc-id="${locId}"></div>
                <div class="text-end mt-3">
                  <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeLocation('${locId}')">Remove Location</button>
                </div>
              </div>
            </div>
          </div>
        </div>`;
      document.getElementById("locationsContainer").insertAdjacentHTML("beforeend", html);

      // Load machines if editing
      if (siteData.machines) siteData.machines.forEach(m => addMachine(locId, m));
    }

    function addMachine(locId, mData = {}) {
      const container = document.querySelector(`.machines-container[data-loc-id="${locId}"]`);
      if (!container) return;

      const html = `
        <div class="card machine-card">
          <div class="card-body row g-3">
            <div class="col-md-3">
              <label>Machine Sl No</label>
              <input type="text" class="form-control machineno" value="${mData.machineno || ''}" />
            </div>
            <div class="col-md-3">
              <label>Type</label>
              <input type="text" class="form-control machinetype" value="${mData.machinetype || ''}" />
            </div>
            <div class="col-md-3">
              <label>Make</label>
              <input type="text" class="form-control make" value="${mData.make || ''}" />
            </div>
            <div class="col-md-3">
              <label>Model</label>
              <input type="text" class="form-control model" value="${mData.model || ''}" />
            </div>
            <div class="col-md-3">
              <label>AMC Expiry</label>
              <input type="date" class="form-control amc_expiry_date" value="${formatDate(mData.amc_expiry_date)}" />
            </div>
          </div>
          <div class="text-end p-2">
            <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.machine-card').remove()">Remove Machine</button>
          </div>
        </div>`;
      container.insertAdjacentHTML("beforeend", html);
    }

    function removeLocation(locId) {
      const loc = document.querySelector(`.accordion[data-loc-id="${locId}"]`);
      if (loc) loc.remove();
    }

    function resetForm() {
      document.getElementById("mainForm").reset();
      document.getElementById("locationsContainer").innerHTML = "";
      locationCount = 0;
      if (!isEditMode) addLocation();
    }

    // ------------------- Submit form -------------------
    document.getElementById("mainForm").addEventListener("submit", async e => {
      e.preventDefault();
      const customer = {
        customername: document.getElementById("customername").value,
        customershortname: document.getElementById("customershortname").value,
        sites: []
      };

      document.querySelectorAll(".accordion").forEach(loc => {
        const locBody = loc.querySelector(".accordion-body");
        if (!locBody) return;

        const machines = [];
        locBody.querySelectorAll(".machine-card").forEach(m => {
          machines.push({
            machineno: m.querySelector(".machineno")?.value || "",
            machinetype: m.querySelector(".machinetype")?.value || "",
            make: m.querySelector(".make")?.value || "",
            model: m.querySelector(".model")?.value || "",
            amc_expiry_date: m.querySelector(".amc_expiry_date")?.value || null
          });
        });

        const site = {
          sitename: locBody.querySelector(".sitename")?.value || "",
          site_shortname: locBody.querySelector(".site_shortname")?.value || "",
          addr1: locBody.querySelector(".addr1")?.value || "",
          addr2: locBody.querySelector(".addr2")?.value || "",
          city: locBody.querySelector(".city")?.value || "",
          state: locBody.querySelector(".state")?.value || "",
          pincode: locBody.querySelector(".pincode")?.value || "",
          phone: locBody.querySelector(".phone")?.value || "",
          email: locBody.querySelector(".email")?.value || "",
          gstno: locBody.querySelector(".gstno")?.value || "",
          machines
        };
        customer.sites.push(site);
      });

      try {
        const method = isEditMode ? "PUT" : "POST";
        const url = isEditMode ? `/customers/${editId}` : "/customers";

        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(customer)
        });

        if (!res.ok) {
          const msg = await res.text();
          alert("Failed to save customer: " + msg);
          return;
        }

        alert("Customer saved successfully!");
        window.location.href = "/customer_list";
      } catch (err) {
        console.error(err);
        alert("Error saving customer");
      }
    });

    // ------------------- Init -------------------
    document.addEventListener("DOMContentLoaded", () => {
      if (!isEditMode) addLocation();
      loadCustomerData();
    });
  </script>
</body>
</html>
