<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer List</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/v/bs5/dt-1.13.6/datatables.min.css" rel="stylesheet"/>

  <style>
    .cursor-pointer { cursor: pointer; }
    td.details-control {
      text-align: center;
      cursor: pointer;
      vertical-align: middle;
      width: 30px;
    }
    .child-row { background-color: #f9f9f9; padding: 10px; border-radius: 5px; }
  </style>
</head>
<body class="bg-light py-4">
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h2>Customer List</h2>
    <a href="{{ url_for('form') }}?mode=new" class="btn btn-success">+ Add New Customer</a>
  </div>

  <table id="customerTable" class="table table-bordered table-hover" style="width:100%">
    <thead class="table-light">
      <tr>
        <th></th>
        <th>#</th>
        <th>Customer Name</th>
        <th>Short Name</th>
        <th>Active</th>
        <th>Total Locations</th>
        <th>Total Machines</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/v/bs5/dt-1.13.6/datatables.min.js"></script>

<script>
let customers = [];

async function loadCustomers() {
  const res = await fetch("/customers");
  customers = await res.json();
  table.clear().rows.add(customers).draw();
}

async function deleteCustomer(id) {
  if (!confirm("Are you sure you want to delete this customer?")) return;
  const res = await fetch(`/customers/${id}`, { method: "DELETE" });
  if (res.ok) {
    alert("Customer deleted successfully");
    loadCustomers();
  } else {
    const err = await res.text();
    alert("Failed to delete customer" + err);
  }
}

async function inactiveCustomer(id) {
  if (!confirm("Are you sure you want to inactivate this customer?")) return;
  const res = await fetch(`/customers/${id}/inactive`, { method: "PUT" });
  if (res.ok) {
    alert("Customer inactivated successfully");
    loadCustomers();
  } else {
    const err = await res.text();
    alert("Failed to inactivate customer" + err);
  }
}

function formatDetails(customer) {
  if (!customer.sites || customer.sites.length === 0) return '<em>No locations found.</em>';
  let html = '';
  customer.sites.forEach((site, i) => {
    html += `
      <div class="child-row mb-2">
        <h6>Location ${i+1}: ${site.sitename} (${site.site_shortname})</h6>
        <p><strong>Address:</strong> ${site.addr1}, ${site.addr2}, ${site.city}, ${site.state} - ${site.pincode}</p>
        <p><strong>Phone:</strong> ${site.phone} | <strong>Email:</strong> ${site.email}</p>
        <p><strong>GST No:</strong> ${site.gstno}</p>
        <strong>Machines:</strong>
        ${
          site.machines.length === 0
            ? "<em>No machines found.</em>"
            : `<ul>${site.machines.map(m => `
                <li><strong>Type:</strong> ${m.machinetype}, <strong>Make:</strong> ${m.make}, <strong>Model:</strong> ${m.model}, <strong>AMC:</strong> ${m.amc_expiry_date ? new Date(m.amc_expiry_date).toLocaleDateString('en-GB') : 'N/A'}</li>
              `).join('')}</ul>`
        }
      </div>`;
  });
  return html;
}

$(document).ready(function() {
  window.table = $('#customerTable').DataTable({
    data: [],
    columns: [
      { className: 'details-control', orderable: false, data: null, defaultContent: '' },
      { data: null, render: (data, type, row, meta) => meta.row + 1 },
      { data: 'customername' },
      { data: 'customershortname' },
      { data: 'isactive' },
      { data: 'sites', render: sites => sites.length },
      { data: 'sites', render: sites => sites.reduce((sum, s) => sum + (s.machines?.length || 0), 0) },
      {
        data: null,
        render: data => `
          <a href="form?mode=edit&id=${data.customerid}" class="btn btn-sm btn-primary me-1">Edit</a>
          <button class="btn btn-sm btn-danger delete-btn" data-id="${data.customerid}">Del</button>
                    <button class="btn btn-sm btn-danger inactive-btn" data-id="${data.customerid}">Inactive</button>

        `
      }
    ],
    order: [[2, 'asc']],
    responsive: true
  });

  loadCustomers();

  // Expand/collapse rows
  $('#customerTable tbody').on('click', 'td.details-control', function () {
    const tr = $(this).closest('tr');
    const row = table.row(tr);
    if (row.child.isShown()) {
      row.child.hide(); tr.removeClass('shown');
    } else {
      row.child(formatDetails(row.data())).show(); tr.addClass('shown');
    }
  });

  // Add caret icons
  function addCarets() {
    $('#customerTable tbody td.details-control').each(function () {
      $(this).html(`
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
             class="bi bi-caret-right-fill" viewBox="0 0 16 16">
          <path d="M12.14 8L5.7 12.796V3.204L12.14 8z"/>
        </svg>
      `);
    });
  }
  addCarets();
  table.on('draw', addCarets);

  // Delete button
  $('#customerTable').on('click', '.delete-btn', function () {
    const id = $(this).data('id');
    deleteCustomer(id);
  });

  // inactive button
  $('#customerTable').on('click', '.inactive-btn', function () {
    const id = $(this).data('id');
    inactiveCustomer(id);
  });

});
</script>
</body>
</html>
